services:
  redis:
    image: redis:alpine
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # This service exists primarily to build the 'mcp-server:latest' image
  # that the Orchestrator will spawn dynamically.
  mcp-placeholder:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    image: mcp-server:latest
    container_name: mcp-server-template
    command: ["echo", "MCP Server Image Built and Registered"]
    restart: "no"
    networks:
      - mcp-network

  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - REDIS_URL=redis://redis:6379
      - LLM_PROVIDER=${LLM_PROVIDER:-gemini}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PORT=3000
    volumes:
      # Critical: Allows the Orchestrator to spawn sibling containers
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      redis:
        condition: service_healthy
      mcp-placeholder:
        condition: service_started
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
