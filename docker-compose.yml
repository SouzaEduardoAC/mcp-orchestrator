services:
  # This service exists primarily to build the 'mcp-server:latest' image
  # that the Orchestrator will spawn dynamically.
  mcp-placeholder:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    image: mcp-server:latest
    container_name: mcp-server-template
    command: ["echo", "MCP Server Image Built and Registered"]
    restart: "no"
    networks:
      - app_network

  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - REDIS_URL=redis://redis:6379
      - LLM_PROVIDER=${LLM_PROVIDER:-gemini}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MAX_OUTPUT_TOKENS=${MAX_OUTPUT_TOKENS:-8192}
      - PORT=3000
      # Phase 3: Conversation Management
      - ENABLE_CONVERSATION_COMPRESSION=${ENABLE_CONVERSATION_COMPRESSION:-false}
      - MAX_HISTORY_TOKENS=${MAX_HISTORY_TOKENS:-30000}
      - HISTORY_TTL_SECONDS=${HISTORY_TTL_SECONDS:-86400}
    volumes:
      # Critical: Allows the Orchestrator to spawn sibling containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Persist MCP configuration across restarts
      - mcp-config:/usr/src/app
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    depends_on:
      mcp-placeholder:
        condition: service_started
    networks:
      - app_network

networks:
  app_network:
    external: true

volumes:
  mcp-config:
